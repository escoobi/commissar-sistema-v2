{% extends "base.html" %}

{% block title %}Processar - Sistema de Comissão{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <h1 class="title">Processar Arquivos</h1>
        <p class="subtitle">Faça upload de arquivos CSV/XLSX para processar dados</p>
        
        <div class="columns">
            <!-- Upload Saída -->
            <div class="column is-half">
                <div class="box">
                    <h2 class="title is-4">
                        <i class="fas fa-file-csv"></i> Upload - Saída
                    </h2>
                    <p class="mb-4">Arquivo com dados de vendas realizadas</p>
                    
                    <form id="form-saida">
                        <div class="file has-name">
                            <label class="file-label">
                                <input class="file-input" type="file" name="arquivo" accept=".csv,.xlsx" required>
                                <span class="file-cta">
                                    <span class="file-icon">
                                        <i class="fas fa-upload"></i>
                                    </span>
                                    <span class="file-label">Escolha o arquivo</span>
                                </span>
                                <span class="file-name">
                                    Nenhum arquivo selecionado
                                </span>
                            </label>
                        </div>
                        
                        <button type="submit" class="button is-primary is-fullwidth mt-4">
                            <span class="icon"><i class="fas fa-arrow-up"></i></span>
                            <span>Processar Saída</span>
                        </button>
                    </form>
                    
                    <div id="result-saida" class="mt-4"></div>
                </div>
            </div>
            
            <!-- Upload Proposta -->
            <div class="column is-half">
                <div class="box">
                    <h2 class="title is-4">
                        <i class="fas fa-file-csv"></i> Upload - Proposta
                    </h2>
                    <p class="mb-4">Arquivo com dados de propostas e financiamentos</p>
                    
                    <form id="form-proposta">
                        <div class="file has-name">
                            <label class="file-label">
                                <input class="file-input" type="file" name="arquivo" accept=".csv,.xlsx" required>
                                <span class="file-cta">
                                    <span class="file-icon">
                                        <i class="fas fa-upload"></i>
                                    </span>
                                    <span class="file-label">Escolha o arquivo</span>
                                </span>
                                <span class="file-name">
                                    Nenhum arquivo selecionado
                                </span>
                            </label>
                        </div>
                        
                        <button type="submit" class="button is-primary is-fullwidth mt-4">
                            <span class="icon"><i class="fas fa-arrow-up"></i></span>
                            <span>Processar Proposta</span>
                        </button>
                    </form>
                    
                    <div id="result-proposta" class="mt-4"></div>
                </div>
            </div>
        </div>
        
        <!-- Status de Processamento -->
        <div class="box mt-5">
            <h2 class="title is-4">
                <i class="fas fa-info-circle"></i> Status
            </h2>
            <div id="status-container">
                <p class="has-text-grey">Nenhum arquivo processado ainda</p>
            </div>
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handler para upload de saída
    document.getElementById('form-saida').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile(this, '/upload/saida', 'result-saida');
    });
    
    // Handler para upload de proposta
    document.getElementById('form-proposta').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile(this, '/upload/proposta', 'result-proposta');
    });
    
    // Update file name on change
    document.querySelectorAll('.file-input').forEach(input => {
        input.addEventListener('change', function() {
            let fileName = this.files[0]?.name || 'Nenhum arquivo selecionado';
            this.parentElement.parentElement.querySelector('.file-name').textContent = fileName;
        });
    });
});

function uploadFile(form, endpoint, resultElementId) {
    const formData = new FormData(form);
    const resultElement = document.getElementById(resultElementId);
    
    console.log('Iniciando upload para:', endpoint);
    resultElement.innerHTML = '<div class="notification is-info"><i class="fas fa-spinner fa-spin"></i> Enviando arquivo...</div>';
    
    fetch(endpoint, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        
        if (data.status === 'sucesso') {
            resultElement.innerHTML = `
                <div class="notification is-success">
                    <button class="delete"></button>
                    <i class="fas fa-check-circle"></i> 
                    <strong>Sucesso!</strong> ${data.mensagem}
                </div>
            `;
        } else {
            resultElement.innerHTML = `
                <div class="notification is-danger">
                    <button class="delete"></button>
                    <i class="fas fa-exclamation-circle"></i> 
                    <strong>Erro:</strong> ${data.mensagem}
                </div>
            `;
        }
        
        // Close button
        resultElement.querySelector('.delete')?.addEventListener('click', function() {
            resultElement.innerHTML = '';
        });
    })
    .catch(error => {
        console.error('Fetch error:', error);
        resultElement.innerHTML = `
            <div class="notification is-danger">
                <button class="delete"></button>
                <i class="fas fa-exclamation-circle"></i> 
                Erro na requisição: ${error.message}
            </div>
        `;
        
        resultElement.querySelector('.delete')?.addEventListener('click', function() {
            resultElement.innerHTML = '';
        });
    });
}
</script>
{% endblock %}
